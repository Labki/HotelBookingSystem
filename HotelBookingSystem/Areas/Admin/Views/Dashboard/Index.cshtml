@model HotelBookingSystem.Areas.Admin.Controllers.AdminDashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<h2 class="fw-bold mb-4">Admin Dashboard</h2>

<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">Total Rooms</h5>
                <h2>@Model.TotalRooms</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Total Bookings</h5>
                <h2>@Model.TotalBookings</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm text-dark bg-warning">
            <div class="card-body">
                <h5 class="card-title">Pending</h5>
                <h2>@Model.PendingBookings</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">Today Check-ins</h5>
                <h2>@Model.TodayCheckIns</h2>
            </div>
        </div>
    </div>
</div>
<div>
    <div>
        <h4 class="mb-3">Latest Bookings</h4>
        <div class="card shadow-sm">
            <div class="card-body">
                @if (!Model.LatestBookings.Any())
                {
                    <p class="text-muted">No bookings yet.</p>
                }
                else
                {
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Room</th>
                                <th>Type</th>
                                <th>Full Name</th>
                                <th>Check-In</th>
                                <th>Check-Out</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var b in Model.LatestBookings)
                            {
                                <tr>
                                    <td>@b.Room?.Name</td>
                                    <td>@b.Room?.Type</td>
                                    <td>@b.User.FirstName @b.User.LastName</td>
                                    <td>@b.CheckInDate.ToShortDateString()</td>
                                    <td>@b.CheckOutDate.ToShortDateString()</td>
                                    <td>
                                        @switch (b.Status)
                                        {
                                            case HotelBookingSystem.Models.BookingStatus.Pending:
                                                <span class="badge bg-warning text-dark">Pending</span>
                                                break;
                                            case HotelBookingSystem.Models.BookingStatus.Confirmed:
                                                <span class="badge bg-success">Confirmed</span>
                                                break;
                                            case HotelBookingSystem.Models.BookingStatus.Completed:
                                                <span class="badge bg-primary">Completed</span>
                                                break;
                                            case HotelBookingSystem.Models.BookingStatus.Cancelled:
                                                <span class="badge bg-danger">Cancelled</span>
                                                break;
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
    <div>
        @{
            var calendar = Model.Calendar;
        }

        <h4 class="mt-4 mb-3">Booking Calendar</h4>

        <div class="table-responsive">
            <table class="table table-bordered calendar-table">
                <thead class="table-light">
                    <tr>
                        <th>Room</th>
                        @foreach (var d in calendar.Dates)
                        {
                            <th class="text-center">@d.ToString("dd MMM")</th>
                        }
                    </tr>
                </thead>

                <tbody>
                    @{
                        var dates = calendar.Dates;
                    }

                    @foreach (var room in calendar.Rooms)
                    {
                        <tr>
                            <td><strong>@room.Name</strong></td>

                            @{
                                int i = 0;
                            }

                            @while (i < dates.Count)
                            {
                                var day = dates[i];
                                
                                var booking = calendar.Bookings
                                .FirstOrDefault(b =>
                                b.RoomId == room.Id &&
                                b.Status != BookingStatus.Cancelled &&
                                day >= b.CheckInDate.Date &&
                                day <= b.CheckOutDate.Date);

                                if (booking == null)
                                {
                                    <td class="free-cell"></td>
                                    i++;
                                    continue;
                                }

                                int span = 0;
                                while (i + span < dates.Count &&
                                dates[i + span] >= booking.CheckInDate.Date &&
                                dates[i + span] <= booking.CheckOutDate.Date)
                                {
                                    span++;
                                }

                                <td colspan="@span"
                                    class="booking-cell @booking.Status.ToString().ToLower() booking-tooltip"
                                    data-price="€@booking.TotalPrice"
                                    data-name="@booking.User.FirstName @booking.User.LastName"
                                    data-checkin="@booking.CheckInDate.ToShortDateString()"
                                    data-checkout="@booking.CheckOutDate.ToShortDateString()">

                                    <span class="booking-label">@booking.User.FirstName @booking.User.LastName</span>

                                    <div class="tooltip-box">
                                        <div>
                                            <strong>@booking.User.FirstName @booking.User.LastName</strong>
                                            <br />
                                            Price: €@booking.TotalPrice<br />
                                        </div>
                                        <div>
                                            Check-In: @booking.CheckInDate.ToShortDateString()<br />
                                            Check-Out: @booking.CheckOutDate.ToShortDateString()
                                        </div>
                                    </div>
                                </td>
                                
                                i += span;
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <style>
            .booking-tooltip {
                position: relative;
                cursor: pointer;
            }

            .tooltip-box {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
                position: absolute;
                top: 90%;
                left: 0;
                background: #222;
                color: #fff;
                padding: 8px 12px;
                border: 2px solid transparent;
                border-radius: 6px;
                font-size: 13px;
                white-space: nowrap;
                box-shadow: 0 3px 8px rgba(0,0,0,0.3);
                opacity: 0;
                pointer-events: none;
                transition: opacity .2s ease-in-out, top .2s ease-in-out;
                z-index: 100;
            }

            .booking-tooltip:hover .tooltip-box {
                opacity: 1;
                top: 110%;
            }

            .tooltip-box.locked {
                opacity: 1 !important;
                top: 105% !important;
                pointer-events: auto;
                border-color: #fff;
            }

            .calendar-table tbody tr:last-child .tooltip-box,
            .calendar-table tbody tr:nth-last-child(2) .tooltip-box {
                top: -150% !important;
            }

            .calendar-table tbody tr:last-child .booking-tooltip:hover .tooltip-box,
            .calendar-table tbody tr:nth-last-child(2) .booking-tooltip:hover .tooltip-box {
                top: -175% !important;
            }

            .calendar-table tbody tr:last-child .tooltip-box.locked,
            .calendar-table tbody tr:nth-last-child(2) .tooltip-box.locked {
                top: -170% !important;
            }

            .calendar-table th,
            .calendar-table td {
                padding: 6px;
                min-width: 80px;
            }
            .calendar-table th {
                text-align: center;
            }

            .free-cell {
                background: #f8f9fa;
            }

            .pending {
                background: #ffc107 !important;
                color: black;
            }

            .confirmed {
                background: #28a745 !important;
                color: white;
            }

            .completed {
                background: #0d6efd !important;
                color: white;
            }

            .cancelled {
                background: #dc3545 !important;
                color: white;
            }
        </style>
        <script>
            let lockedTooltip = null;

            document.addEventListener("click", function (event) {
                let cell = event.target.closest(".booking-tooltip");

                if (cell) {
                    let tooltip = cell.querySelector(".tooltip-box");

                    if (lockedTooltip && lockedTooltip !== tooltip) {
                        lockedTooltip.classList.remove("locked");
                    }

                    tooltip.classList.toggle("locked");
                    lockedTooltip = tooltip.classList.contains("locked") ? tooltip : null;

                    return;
                }
                if (lockedTooltip) {
                    lockedTooltip.classList.remove("locked");
                    lockedTooltip = null;
                }
            });
        </script>
    </div>
</div>
